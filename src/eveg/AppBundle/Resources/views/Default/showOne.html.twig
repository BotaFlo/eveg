{# src/eveg/AppBundle/Resources/views/Default/viewOne.html.twig #}

{% extends "::layout.html.twig" %}

{% block stylesheets %}
	<link rel="stylesheet" href="{{ asset('css/fancytree/skin-win8/ui.fancytree.min.css') }}" type="text/css" />
	{{ parent() }}
	<link rel="stylesheet" type="text/css" href="{{ asset('bundles/bmatznerfontawesome/css/font-awesome.min.css') }}" />
{% endblock %}

{% block title %}
	{% if syntaxon is defined %}
		{{ syntaxon.syntaxonName }} | {{ parent() }}
	{% endif %}
	{% if multipleSyntaxon is defined %}
		Plusieurs résultats | {{ parent() }}
	{% endif %}
{% endblock %}

{% block body %}

	{{ parent() }}


	{% if redirectionSyntaxon is defined %}
		<p>Vous avez été redirigé vers le syntaxon retenu pour votre recherche concernant "<span class="{{ redirectionSyntaxon.level }}-text">{{ redirectionSyntaxon.syntaxon }}</span>".</p>
	{% endif %}

	{% if redirectionMultipleSyntaxon is defined %}
		<p>Plusieurs syntaxons correpondent à votre recherche concernant "<span class="{{ redirectionMultipleSyntaxon.level }}-text">{{ redirectionMultipleSyntaxon.syntaxon }}</span>".</p>
	{% endif %}

	{% if redirectionFromSynonym is defined %}
		<p>Vous avez été redirigé vers le syntaxon retenu pour votre recherche concernant "<span class="{{ redirectionFromSynonym.level }}-text">{{ redirectionFromSynonym.syntaxon }}</span></p>
	{% endif %}

	{% if syntaxon is defined %}
		{#{{ dump(syntaxon) }}#}
		{#{{ dump(synonyms) }}#}
	{% endif %}

	{% if multipleSyntaxon is defined %}
		{#{{ dump(multipleSyntaxon) }}#}
	{% endif %}

	{% if allParents is defined %}
		{#{{ dump(allParents) }}#}
	{% endif %}

	{% if syntaxon is defined %}

		{# Flashbags #}
		{#{% for type, messages in app.session.flashBag.all %}
		    {% for message in messages %}
		        {%if type == 'error'%} {% set type = 'danger' %} {%endif%}
		        <div class="alert alert-{{ type }} alert-dismissible">
		        	<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
		            {{ message|raw }}
		        </div>
		    {% endfor %}
		{% endfor %}#}

		{# PanelOptions & SearchBar #}
		<div class="row">
			<div class="col-md-4 colPanelOptions hidden-xs hidden-sm">
				{{ render(controller("evegAppBundle:Default:panelOptions", {
					'showFilters': true,
					'showFeedback': true,
					'showCompare': true,
					'showPdfExport': true
				})) }}
			</div>
			<div class="col-md-8">
				{# Searchbox #}
				<div class="row searchRow">
					
				</div>
			</div>
		</div>

		<div class="row appShowRow">

			<div class="col-md-4 hidden-xs hidden-sm" id="divTree">
				<div>
					
				</div>
				<i class="loadTreeIcon glyphicon glyphicon-refresh glyphicon-refresh-animate"></i>
			</div>

			{# show data #}
			<div class="col-md-8" id="cardView">

				{# Card header #}
					{% include 'evegAppBundle:Default/Fragments:cardHeader.html.twig' %}

				{# Breadcrumb #}
				<div class="row flexBreadcrumb hidden-xs hidden-sm">
						{% for syntaxon in allParents %}
							{% if syntaxon.level != 'HAB' %}
								<div class="flexBreadcrumbItem"><a href="{{ path('eveg_show_one', {'id': syntaxon.id}) }}" class="{{ syntaxon.level }}-text">{{ syntaxon.syntaxon }}</a></div>

								{% if not loop.last %}
									<span class="breadcrumbSeparator">/</span>
								{% endif %}
							{% endif %}
						{% endfor %}
				</div>

				{# Breadcrumb for xm & xs views#}
				<div class="row hidden-lg hidden-md">
					{% for syntaxon in allParents %}
						{% if syntaxon.level != 'HAB' %}
								<a href="{{ path('eveg_show_one', {'id': syntaxon.id}) }}" class="{{ syntaxon.level }}-text {{ syntaxon.level }}-indent">{{ syntaxon.syntaxon }}</a><br />
						{% endif %}
					{% endfor %}
				</div>

				{# Data #}
				<div class="row">
					<div class="col-md-8 viewLeft">

						{# Synonyms #}
						{% if synonyms is defined %}
							<div class="panel panel-default">
								<div class="panel-heading panelSynonymsHeader">Synonymes{% if synonyms is empty %} : aucun synonyme trouvé{% endif %}<span class="synonymsShowAll pull-right">Afficher tout</span></div>
								<ul class="list-group">
									{% for synonym in synonyms %}
										<li class="list-group-item synonymBox">
											{{ synonymType(synonym.level)|raw }}
											<a href="{{ path('eveg_show_one', {'id': synonym.id}) }}">
												{{ synonym.syntaxon }}
											</a>
										</li>
									{% endfor %}
								</ul>
							</div> <!-- ./ panel -->
						{% endif %}
						<p>

						{# Ecological specifications #}
						<div class="panel panel-default">
							<div class="panel-heading">Caractéristiques écologiques</div>
							<div class="panel-body">
								Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.
							</div>
						</div>

						{# Floristic cortege #}
						<div class="panel panel-default">
							<div class="panel-heading">Cortège floristique</div>
							<div class="panel-body">
								Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.
							</div>
						</div>

						{# Resources #}
						<div class="panel panel-default">
							<div class="panel-heading panelFilesHeader">Ressources{% if syntaxon.syntaxonFiles is empty %} : aucune{% endif %}<span class="filesShowAll pull-right">Afficher tout</span></div>
							{% if syntaxon.syntaxonFiles is not empty %}
								<ul class="list-group">
									{% for file in syntaxon.syntaxonFiles %}
										<li class="list-group-item fileBox">
											{% if file.type == 'spreadsheet' %}
												<i class="fa fa-file-excel-o"></i>
											{% elseif file.type == 'pdf' %}
												<i class="fa fa-file-pdf-o"></i>
											{% endif %}
											<a href="{{ path('eveg_download_file', {'id': syntaxon.id, 'idFile': file.id}) }}">{{ file.title }}</a>
											{% if file.user.id == app.user.id %}
												<div class="pull-right">
													<i class="fa fa-pencil-square-o"></i>
													<a href="{{ path('eveg_edit_file', {'id': syntaxon.id, 'idFile': file.id}) }}">Modifier</a>
												</div>
											{% endif %}
										</li>
									{% endfor %}
								</ul>
							{% else %}
								{% if is_granted('ROLE_USER') %}
									<a href="{{ path('eveg_add_file', {'id': syntaxon.id}) }}">Ajouter un document</a>
								{% endif %}
							{% endif %}
						</div>

						{# Bibliography #}
						<div class="panel panel-default">
							<div class="panel-heading">Bibliographie</div>
							<div class="panel-body">
								Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.
							</div>
						</div>

					</div> <!-- ./viewLeft -->

					<div class="col-md-4 viewRight">
						<!-- photos -->
						<div class="panel panel-default">
							<div class="panel-heading">Illustrations{% if syntaxon.syntaxonPhotos is empty %} : aucune{% endif %}</div>
							{% if syntaxon.syntaxonPhotos is not empty %}
								<div class="panel-body">
									{% set nbPhotos = syntaxon.syntaxonPhotos|length %}
									{% set randomPhoto = random(nbPhotos-1) %}
									<a href="{{ path('eveg_show_photos', {'id': syntaxon.id}) }}" target="_blank">
										<img class="syntaxonIllustration" src="{{ vich_uploader_asset(syntaxon.syntaxonPhotos[randomPhoto], 'imageFile') | imagine_filter('thumb') }}" alt="{{ syntaxon.syntaxonName }}">
									</a>
									{#
									<img class="syntaxonIllustration" src="{{ 'uploads/images/syntaxons/56db469b40b94.JPG' | imagine_filter('thumb') }}" alt="{{ syntaxon.syntaxonName }}">
									#}
									{#
									<img class="syntaxonIllustration" src="{{ vich_uploader_asset(syntaxon.syntaxonPhotos[0], 'imageFile') }} | imagine_filter('thumb') }}" alt="{{ syntaxon.syntaxonName }}">
									#}
								</div>
							{% endif %}
							{% if is_granted('ROLE_USER') %}
								<a href="{{ path('eveg_add_photo', {'id': syntaxon.id}) }}">
									<div class="text-center">Ajouter une photo</div>
								</a>
							{% endif %}
						</div>
						<!-- Fr departments repartition -->
						<div class="panel panel-default">
							<div class="panel-heading">France</div>
							<div class="panel-body">
								<div id="mapDepFr"></div>
								<div id="mapDepFrHoverLegend"></div>
								<div id="mapDepFrToggleLegend">Légende</div>
								<div id="mapDepFrLegend"></div>
							</div>
						</div>
						<!-- EU+ coutries repartition -->
						<div class="panel panel-default">
							<div class="panel-heading">Europe</div>
							<div class="panel-body">
								<div id="mapEurope"></div>
								<div id="mapEuropeHoverLegend"></div>
								<div id="mapEuropeToggleLegend">Légende</div>
								<div id="mapEuropeLegend"></div>
							</div>
						</div>
					</div> <!-- ./viewRight -->
				</div> <!-- ./row -->
			</div> <!-- ./col-md-8 -->
		</div>

	{% endif %}

{% endblock %}

{% block javascript %}
	{{ parent() }}
	<script>
		$(".loadTreeIcon").hide();
	</script>
	<!-- JQUERY COOKIE -->
	<script src="{{ asset('js/jquery.cookie.js') }}" type="text/javascript"></script>

	<!-- FANCY TREE -->
	<script src="{{ asset('js/jquery.fancytree.js') }}" type="text/javascript"></script>
	<script src="{{ asset('js/jquery.fancytree.persist.js') }}" type="text/javascript"></script>
	<!-- Initialize the tree when page is loaded -->
	<script src="{{ asset('js/treeApp.js') }}" type="text/javascript"></script>

	<!-- AUTOCOMPLETE -->
	<script src="{{ asset('js/autocomplete.js') }}" type="text/javascript"></script>
	<script>
		$('.searchIcon').hide();
		$('.badge-addon').hide();
		monkeyPatchAutocomplete();
		$('#searchbox').autocomplete({
			source: '{{ url("api_get_syntaxon_search") }}',
			minLength: 3,
			search: function(event, ui) {
				$('.badge-addon').hide();
				$('.searchIcon').show();
			},
			response: function(event, ui) {
				$('.searchIcon').hide();
				$('.badge-addon').text(ui.content.length);
				$('.badge-addon').show();
			},
			focus: function(event, ui) {
		        event.preventDefault();
		    },
		    change: function(event, ui) {
		    	$('.badge-addon').hide();
		    },
		    close: function(event, ui) {
		    	$('.badge-addon').hide();
		    },
			select : function(event, ui){
				event.preventDefault();
				//alert( Routing.generate('api_get_syntaxon_node', { id: ui.item.id }, true) );
				window.location.replace(Routing.generate('eveg_show_one', { id: ui.item.id }, true));
				$('.badge-addon').hide();
			}
		});
	</script>

	<!-- REPARTITION FILTERS -->
	<!-- FR DEPARTMENT FILTER -->
	<script>
		var appSessionSF2DepFrFilter = '{{ app.session.get("depFrFilter") | raw }}';
		var depFrFilter;
		if('{{ app.session.get("depFrFilter") | raw }}' != '') {
			depFrFilter = jQuery.parseJSON(appSessionSF2DepFrFilter);
		} else {
			depFrFilter = null;
		}
		for(cb in depFrFilter) {
			$(".cbFrFilter[name="+cb+"]").prop('checked', true);
		}
	</script>

	<!-- UE FILTER -->
	<script>
		var appSessionSF2UeFilter = '{{ app.session.get("ueFilter") | raw }}';
		var ueFilter;
		if('{{ app.session.get("ueFilter") | raw }}' != '') {
			ueFilter = jQuery.parseJSON(appSessionSF2UeFilter);
		} else {
			ueFilter = null;
		}
		for(cb in ueFilter) {
			$(".cbUeFilter[name="+cb+"]").prop('checked', true);
		}
	</script>

	<!-- RESIZABLE -->
	<!--
	<script src="{{ asset('js/resizable.js') }}" type="text/javascript"></script>
	<script>
		$("#divTree").resizable({
	        alsoResizeReverse: "#notTree"
	    });
	</script>
	-->

	<!-- EXPAND NODES -->
	<script>
		{% if syntaxon is defined%}
			function expandNodes(){
				$(".loadTreeIcon").show();
				var tree = $("#divTree").fancytree("getTree");
				tree.loadKeyPath("{% if allParents is defined %}{% for parent in allParents %}/{{ parent.id }}{% endfor %}/{{ syntaxon.id}}{% endif %}", function(node, status){
				  
				  if(status === "loaded") {
				    //console.log("loaded intermiediate node " + node);
				  }
				  
				  if(status === "ok") {
				    tree.activateKey("{{ syntaxon.id }}");
				    $(".loadTreeIcon").hide();
				  }


				  //console.debug("node [" + node + "]: " + status)
				});
			}
		{% endif %}
	</script>

	<!-- MAPS -->
	{% javascripts 
		'@evegAppBundle/Resources/public/js/maps/*'
		'js/maps/*' %}
		<script type="text/javascript" src="{{ asset_url }}"></script>
	{% endjavascripts %}

	<script>
		var repDepFr = '{{ repDepFrJson | raw }}';
		createMapDepFr(document.getElementById('mapDepFr'),
			           document.getElementById('mapDepFrHoverLegend'),
			           document.getElementById('mapDepFrLegend'),
			           repDepFr,
			           0.55);
		$("#mapDepFrLegend").hide();
		$("#mapDepFrToggleLegend").click(function(){
			$("#mapDepFrLegend").toggle();
		});
	</script>

	<!-- UE map-->
	<script>
		var repUE = '{{ repUeJson | raw }}';
		createMapEurope(document.getElementById('mapEurope'),
						document.getElementById('mapEuropeHoverLegend'),
						document.getElementById('mapEuropeLegend'),
						repUE,
						0.55);
		$("#mapEuropeLegend").hide();
		$("#mapEuropeToggleLegend").click(function(){
			$("#mapEuropeLegend").toggle();
		});
	</script>
	
	<!-- BOOTSTRAP TOOLTIP -->
	<script>
		$(".showTooltip").tooltip({html:true});
		$('[data-tooltip="tooltip"]').tooltip();
	</script>

	<!-- LIMIT THE NUMBER OF VISIBLE ITEMS -->
	<script>
		function limitResults(label, item, click){
			// label : node to be shown / hidden
			// item : node to limit repetition
			// click : click this element to toggle
			$(label).hide();
			var limit = 3;
			var synonymsExpand = false;
			var nbSynonyms = $(item).size();
			var strExpand = 'Afficher tout (' + nbSynonyms + ')';
			var strMini = 'Réduire';
			$(label).html(strExpand);
			//console.log($('.synonymsBox').size());
			if(nbSynonyms >= limit) {
				synonymsExpand = true;
				$(item).slice(limit).hide();
				$(label).show();
			}
			$(click).click(function(){
				if(synonymsExpand == true) {
					$(item).show();
					$(label).html(strMini);
					synonymsExpand = false
				} else {
					$(item).slice(limit).hide();
					$(label).html(strExpand);
					synonymsExpand = true;
				}	
			});	
		}

		limitResults(".synonymsShowAll", ".synonymBox", ".panelSynonymsHeader");
		limitResults(".filesShowAll", ".fileBox", ".panelFilesHeader");
		
	</script>

	

{% endblock %}